<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dispositivos | ARF</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>

    <nav class="navbar navbar-expand-lg navbar-custom mb-4">
        <div class="container-fluid">
            <a class="navbar-brand ms-3" href="#">
                <i class="fas fa-fingerprint me-2"></i> ARF <span style="font-weight: 300; opacity: 0.8;">Admin</span>
            </a>
            <div class="collapse navbar-collapse">
                <ul class="navbar-nav ms-auto me-4">
                    <li class="nav-item"><a class="nav-link" href="/"><i class="fas fa-chart-line me-1"></i> Dashboard</a></li>
                    <li class="nav-item"><a class="nav-link active" href="/devices"><i class="fas fa-video me-1"></i> Dispositivos</a></li>
                    <li class="nav-item"><a class="nav-link" href="/data"><i class="fas fa-database me-1"></i> Datos</a></li>
                    <li class="nav-item"><a class="nav-link" href="/reports"><i class="fas fa-file-alt me-1"></i> Reportes</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="card shadow mb-4">
            <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between bg-white">
                <h6 class="m-0 font-weight-bold text-primary"><i class="fas fa-list me-2"></i> Listado de Cámaras</h6>
                <button class="btn btn-primary btn-sm rounded-pill px-3" onclick="abrirModal()">
                    <i class="fas fa-plus me-1"></i> Nueva Cámara
                </button>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="bg-light">
                            <tr>
                                <th class="ps-4 py-3">ID</th>
                                <th>NOMBRE</th>
                                <th>CONEXIÓN (IP:PUERTO)</th>
                                <th>UBICACIÓN</th>
                                <th>CREDENCIALES</th>
                                <th class="text-end pe-4">ACCIONES</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for cam in camaras %}
                            <tr>
                                <td class="ps-4 fw-bold text-secondary">#{{ cam.id }}</td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="bg-light rounded-circle p-2 me-2 text-primary">
                                            <i class="fas fa-camera"></i>
                                        </div>
                                        <span class="fw-bold text-dark">{{ cam.nombre }}</span>
                                    </div>
                                </td>
                                <td>
                                    <span class="badge bg-light text-dark border font-monospace">
                                        {{ cam.ip }}:{{ cam.puerto }}
                                    </span>
                                </td>
                                <td>
                                    <span class="badge bg-info bg-opacity-10 text-info border border-info border-opacity-25">
                                        {{ cam.area }}
                                    </span>
                                </td>
                                <td class="text-muted small">
                                    <i class="fas fa-user me-1"></i> {{ cam.user }}
                                </td>
                                <td class="text-end pe-4">
                                    <button class="btn btn-sm btn-outline-primary rounded-circle" style="width: 32px; height: 32px;" onclick='editar({{ cam | tojson }})' title="Editar">
                                        <i class="fas fa-pen" style="font-size: 12px;"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger rounded-circle ms-1" style="width: 32px; height: 32px;" onclick="eliminar({{ cam.id }})" title="Eliminar">
                                        <i class="fas fa-trash" style="font-size: 12px;"></i>
                                    </button>
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="6" class="text-center py-5 text-muted">
                                    <i class="fas fa-video-slash fa-3x mb-3 opacity-25"></i><br>
                                    No hay cámaras configuradas. ¡Agrega una!
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="deviceModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg" style="border-radius: 20px;">
                <div class="modal-header bg-primary text-white" style="border-radius: 20px 20px 0 0;">
                    <h5 class="modal-title fw-bold" id="modalTitle"><i class="fas fa-video me-2"></i> Nueva Cámara</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <form id="formDevice">
                        <input type="hidden" id="devId">
                        
                        <div class="mb-3">
                            <label class="form-label small fw-bold text-muted text-uppercase">Nombre del Dispositivo</label>
                            <input type="text" class="form-control" id="devName" placeholder="Ej: Entrada Principal" required>
                        </div>

                        <div class="row">
                            <div class="col-8 mb-3">
                                <label class="form-label small fw-bold text-muted text-uppercase">Dirección IP</label>
                                <div class="input-group">
                                    <span class="input-group-text bg-light"><i class="fas fa-network-wired"></i></span>
                                    <input type="text" class="form-control" id="devIp" placeholder="192.168.1.X" required>
                                </div>
                            </div>
                            <div class="col-4 mb-3">
                                <label class="form-label small fw-bold text-muted text-uppercase">Puerto</label>
                                <input type="number" class="form-control" id="devPort" value="80" required>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label small fw-bold text-muted text-uppercase">Área / Ubicación</label>
                            <input type="text" class="form-control" id="devArea" placeholder="Ej: Recepción, Casino...">
                        </div>

                        <div class="bg-light p-3 rounded border mb-3">
                            <h6 class="small fw-bold text-primary mb-2"><i class="fas fa-key me-1"></i> Credenciales de Acceso</h6>
                            <div class="row g-2">
                                <div class="col-6">
                                    <input type="text" class="form-control form-control-sm" id="devUser" placeholder="Usuario" value="admin">
                                </div>
                                <div class="col-6">
                                    <input type="password" class="form-control form-control-sm" id="devPass" placeholder="Contraseña">
                                </div>
                            </div>
                        </div>

                        <div class="d-grid">
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="probarConexion()">
                                <i class="fas fa-plug me-1"></i> Probar Conexión
                            </button>
                            <div id="testResult" class="text-center mt-2 small" style="min-height: 20px;"></div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer border-0 pt-0">
                    <button type="button" class="btn btn-light rounded-pill" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary rounded-pill px-4" onclick="guardarDispositivo()">Guardar</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        const deviceModal = new bootstrap.Modal(document.getElementById('deviceModal'));

        function abrirModal() {
            document.getElementById('formDevice').reset();
            document.getElementById('devId').value = '';
            document.getElementById('modalTitle').innerHTML = '<i class="fas fa-video me-2"></i> Nueva Cámara';
            document.getElementById('testResult').innerHTML = '';
            deviceModal.show();
        }

        function editar(cam) {
            document.getElementById('devId').value = cam.id;
            document.getElementById('devName').value = cam.nombre;
            document.getElementById('devIp').value = cam.ip;
            document.getElementById('devPort').value = cam.puerto;
            document.getElementById('devArea').value = cam.area;
            document.getElementById('devUser').value = cam.user;
            document.getElementById('devPass').value = cam.pass;
            
            document.getElementById('modalTitle').innerHTML = '<i class="fas fa-edit me-2"></i> Editar Cámara';
            document.getElementById('testResult').innerHTML = '';
            deviceModal.show();
        }

        function probarConexion() {
            const ip = document.getElementById('devIp').value;
            const port = document.getElementById('devPort').value;
            const user = document.getElementById('devUser').value;
            const pass = document.getElementById('devPass').value;
            
            const btn = document.querySelector('button[onclick="probarConexion()"]');
            const res = document.getElementById('testResult');
            
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Conectando...';
            res.innerHTML = '';

            fetch('/api/devices/test', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ip, port, user, pass})
            })
            .then(r => r.json())
            .then(data => {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-plug me-1"></i> Probar Conexión';
                if(data.status === 'ok') {
                    res.innerHTML = '<span class="text-success fw-bold"><i class="fas fa-check-circle"></i> ¡Conexión Exitosa!</span>';
                } else {
                    res.innerHTML = '<span class="text-danger fw-bold"><i class="fas fa-times-circle"></i> Error: ' + (data.message || 'Sin respuesta') + '</span>';
                }
            })
            .catch(err => {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-plug me-1"></i> Probar Conexión';
                res.innerHTML = '<span class="text-danger fw-bold">Error de red</span>';
            });
        }

        function guardarDispositivo() {
            const data = {
                id: document.getElementById('devId').value,
                nombre: document.getElementById('devName').value,
                ip: document.getElementById('devIp').value,
                puerto: document.getElementById('devPort').value,
                area: document.getElementById('devArea').value,
                user: document.getElementById('devUser').value,
                pass: document.getElementById('devPass').value
            };

            // Validación simple
            if(!data.ip || !data.nombre) {
                Swal.fire('Faltan datos', 'Por favor ingresa al menos Nombre e IP', 'warning');
                return;
            }

            fetch('/api/devices/save', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            }).then(() => {
                deviceModal.hide();
                Swal.fire({
                    title: 'Guardado',
                    text: 'La cámara se ha configurado correctamente',
                    icon: 'success',
                    timer: 1500,
                    showConfirmButton: false
                }).then(() => window.location.reload());
            });
        }

        function eliminar(id) {
            Swal.fire({
                title: '¿Estás seguro?',
                text: "Esta acción eliminará la cámara del sistema.",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Sí, eliminar',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    fetch('/api/devices/delete/' + id, { method: 'DELETE' })
                    .then(() => {
                        Swal.fire(
                            '¡Eliminado!',
                            'La cámara ha sido borrada.',
                            'success'
                        ).then(() => window.location.reload());
                    });
                }
            })
        }
    </script>
</body>
</html>